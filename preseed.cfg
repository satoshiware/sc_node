# =====================================================================
# Custom preseed.cfg for Debian 13 "Trixie" – Headless Minimal Install
#
# Key features that differ from the preseed example (Jan 17th 2026):
#     0) Fully unattended except ONE interactive prompt: password for 'satoshi' user
#
#     1) Timezone fixed to Etc/UTC (generic, location-agnostic)
#
#     2) Guided LVM partitioning that automatically erases the FIRST disk found
#        – No prompts, no confirmation dialogs for partitioning!
#
#     3) Creates user 'satoshi' (full name: Satoshi Nakamoto) with sudo privileges
#        and passwordless sudo (NOPASSWD) for headless/server convenience
#
#     4) Root login is completely disabled
#
#     5) Installs minimal server utilities: openssh-server, curl, git, htop, sudo
#
#     6) debconf/priority set to 'medium' – hides all low-priority questions
#        while still showing the password prompt for 'satoshi'
#
#     7) Hostname set to 'sc-node' (Sovereign Circle Node)
# =====================================================================

# === Locale and keyboard ===
d-i debian-installer/locale string en_US
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us

# === Network configuration (automatic DHCP) ===
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string sc-node
d-i netcfg/get_domain string local

# === Mirror settings (automatic, no prompt) ===
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# === Clock and timezone ===
d-i clock-setup/utc boolean true
d-i time/zone string Etc/UTC
d-i clock-setup/ntp boolean true

# === Partitioning: Guided LVM on first disk – ERASES ENTIRE DISK AUTOMATICALLY ===
d-i partman-auto/method string lvm
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-md/confirm boolean true
d-i partman-lvm/device_remove_lvm boolean true

# === User account setup ===
# Root login disabled
d-i passwd/root-login boolean false

# Create normal user 'satoshi' with full name and sudo privileges
d-i passwd/make-user boolean true
d-i passwd/user-fullname string Satoshi Nakamoto
d-i passwd/username string satoshi
d-i passwd/user-uid string 1000
d-i user-setup/allow-password-weak boolean true
# The password prompt will appear interactively for this user only

# === Add satoshi to sudo group and configure passwordless sudo ===
d-i preseed/late_command string \
    in-target sh -c 'echo "satoshi ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/satoshi'; \
    in-target chmod 0440 /etc/sudoers.d/satoshi; \
    in-target usermod -aG sudo satoshi

# === Package selection: minimal server install ===
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server curl git htop sudo
d-i pkgsel/install-language-support boolean false

# === debconf priority: medium hides most questions but allows password prompt ===
d-i debconf/priority select medium

# === GRUB bootloader ===
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean false
# Boot device auto-detected (safer than hardcoding)

# === Finish installation ===
d-i finish-install/reboot_in_progress note
