# =============================================================================
# Debian 13 "Trixie" preseed.cfg – Mostly Automatic Server Install
#
# Key points of this preseed file:
#   - Designed for fully unattended installs except for ONE interactive prompt:
#     The user will be asked to enter and confirm the password for the 'satoshi' account.
#     Everything else (locale, networking, partitioning, packages, etc.) is fully automatic.
#
#   - Timezone set to ETC/UTC (generic / location-agnostic)
#
#   - Single-disk guided LVM partitioning that **erases the entire first disk** it finds.
#     No prompts, no confirmation dialogs for partitioning – use with caution!
#
#   - Creates user 'satoshi' (full name: Satoshi Nakamoto) with sudo privileges and
#     passwordless sudo (NOPASSWD) for convenience in headless/server environments.
#
#   - Root login is disabled (best practice); rely on sudo instead.
#
#   - Includes basic server utilities (openssh-server, curl, git, htop, sudo).
#
#   - debconf/priority set to 'medium' – this hides most low-priority questions while still
#     allowing the password prompt to appear.
# =============================================================================

# Locale, language and keyboard
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# Network — DHCP (generic / auto-detect)
d-i netcfg/choose_interface select auto
#d-i netcfg/get_hostname string unassigned-hostname  # optional fallback if DHCP fails

# Mirror (works everywhere)
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# Clock / timezone — generic UTC (change post-install if needed)
d-i clock-setup/utc boolean true
d-i time/zone string Etc/UTC
#d-i clock-setup/ntp boolean true

# Debconf priority: medium allows the password prompt while skipping low-priority questions
d-i debconf/priority select medium

# User setup — prompt for password only (no preseed for password → interactive prompt)
d-i passwd/root-login boolean false          # disable direct root login
d-i passwd/make-user boolean true
d-i passwd/user-fullname string Satoshi Nakamoto
d-i passwd/username string satoshi
# IMPORTANT: Do NOT set passwd/user-password or passwd/user-password-crypted here!
# Leaving them unset forces the installer to ask for the password interactively.
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

# Add sudo for satoshi + NOPASSWD (applied in late_command after user exists)
d-i pkgsel/include string sudo
d-i preseed/late_command string \
    in-target usermod -aG sudo satoshi ; \
    echo 'satoshi ALL=(ALL:ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/99-satoshi-nopasswd ; \
    chmod 0440 /target/etc/sudoers.d/99-satoshi-nopasswd

# Partitioning — ERASES THE DISK (first disk found) — guided LVM
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Base system & packages
tasksel tasksel/first multiselect standard system utilities
d-i pkgsel/include string openssh-server curl git htop sudo
d-i base-installer/install-recommends boolean false
popularity-contest popularity-contest/participate boolean false

# GRUB
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

# Finishing
d-i debian-installer/add-kernel-opts string quiet
d-i finish-install/reboot_in_progress note

# Optional extras (commented)
#d-i apt-setup/non-free-firmware boolean true
#d-i apt-setup/backports boolean true
